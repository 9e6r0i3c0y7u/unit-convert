<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>å–®ä½æ›ç®—ç·´ç¿’ï¼ˆPWAï¼‰</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#071022;
      --card:#0f1b33;
      --card2:#0b162c;
      --text:#e6edf7;
      --muted:#9fb0c9;
      --line:#203255;
      --btn:#2d6cff;
      --btn2:#2a3550;
      --ok:#27c07d;
      --bad:#ff5c7a;
      --warn:#ffbf4d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      background:radial-gradient(1200px 600px at 30% 20%, #0e2a57 0%, var(--bg) 55%);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns: 1.1fr 0.9fr;gap:14px;margin-top:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border:1px solid rgba(32,50,85,0.9);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h2{font-size:14px;margin:0 0 10px 0;color:#cfe2ff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:var(--muted)}
    select,input[type="number"],input[type="text"]{
      background:var(--card2); color:var(--text);
      border:1px solid var(--line); border-radius:10px;
      padding:8px 10px; outline:none;
    }
    input[type="text"]{width:220px}
    input[type="number"]{width:110px}
    .btn{
      background:var(--btn); color:white; border:none;
      padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:600;
    }
    .btn.secondary{background:var(--btn2)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      background:var(--card2); border:1px solid var(--line);
      padding:8px 10px;border-radius:999px;color:var(--muted);
      cursor:pointer; user-select:none;
    }
    .tab.active{background:rgba(45,108,255,0.18); color:#dfeaff; border-color:rgba(45,108,255,0.55)}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){ .twoCols{grid-template-columns:1fr} }
    .mini{font-size:12px;color:var(--muted)}
    .question{
      font-size:26px; font-weight:800;
      letter-spacing:0.2px;
      margin:8px 0 6px;
    }
    .sub{
      color:var(--muted); font-size:13px;
    }
    .statline{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size:13px; color:var(--muted);
      margin-top:10px;
    }
    .statline b{color:var(--text)}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .badge.ok{border-color:rgba(39,192,125,0.6);color:#c8ffe6}
    .badge.bad{border-color:rgba(255,92,122,0.6);color:#ffd0d8}
    .badge.warn{border-color:rgba(255,191,77,0.6);color:#ffe7bd}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid rgba(32,50,85,0.65);padding:8px 6px;font-size:12px;color:var(--muted);text-align:left;vertical-align:top}
    th{color:#cfe2ff;font-weight:700}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .checks{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{
      display:flex;gap:6px;align-items:center;
      background:var(--card2);border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted);
    }
    .chip input{transform:translateY(0.5px)}
    .hint{
      margin-top:8px;
      font-size:12px; color:#cfe2ff;
      background:rgba(45,108,255,0.10);
      border:1px dashed rgba(45,108,255,0.45);
      padding:8px 10px;border-radius:12px;
      display:none;
      white-space:pre-wrap;
    }
    .hint.show{display:block}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <h1>å–®ä½æ›ç®—ç·´ç¿’ï¼ˆPWAï¼‰</h1>
    <div class="pill">å®šå‘æ¨¡å¼ / éš¨æ©Ÿæ¨¡å¼ï½œé¿å…å°æ•¸ï¼šç”¨è¤‡åˆå–®ä½å‡ºé¡Œ</div>
  </header>

  <div class="grid">
    <!-- è¨­å®š -->
    <section class="card" id="settingsCard">
      <h2>è¨­å®š</h2>

      <div class="tabs">
        <div class="tab active" data-mode="directed">å®šå‘æ¨¡å¼</div>
        <div class="tab" data-mode="random">éš¨æ©Ÿæ¨¡å¼</div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>é¡Œæ•¸</label><br/>
          <input id="totalQ" type="number" min="1" max="200" value="20"/>
        </div>
        <div>
          <label>æ¯é¡Œæ™‚é–“ï¼ˆç§’ï¼‰</label><br/>
          <input id="timePerQ" type="number" min="1" max="999" value="20"/>
        </div>
        <div style="padding-top:20px">
          <label class="chip" style="cursor:pointer">
            <input id="noTimer" type="checkbox"/> ä¸é™æ™‚
          </label>
        </div>
        <div>
          <label>å‡ºé¡Œä½æ•¸ï¼ˆä¸»æ•¸å­—ï¼‰</label><br/>
          <select id="digits">
            <option value="1">1 ä½æ•¸</option>
            <option value="2">2 ä½æ•¸</option>
            <option value="3" selected>3 ä½æ•¸</option>
          </select>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid rgba(32,50,85,0.6);margin:12px 0"/>

      <!-- å®šå‘æ¨¡å¼ -->
      <div id="directedPanel">
        <div class="row">
          <label>é¡åˆ¥</label>
          <select id="catDirected"></select>
          <span class="mini">å·¦é¸å‡ºé¡Œå–®ä½ã€å³é¸è¦æ±‚å–®ä½</span>
        </div>

        <div class="twoCols" style="margin-top:10px">
          <div>
            <label>å‡ºé¡Œå–®ä½ï¼ˆå·¦ï¼‰</label><br/>
            <select id="fromUnit"></select>
          </div>
          <div>
            <label>è¦æ±‚å–®ä½ï¼ˆå³ï¼‰</label><br/>
            <select id="toUnit"></select>
          </div>
        </div>
      </div>

      <!-- éš¨æ©Ÿæ¨¡å¼ -->
      <div id="randomPanel" style="display:none">
        <div class="mini">å‹¾é¸è¦å‡ºé¡Œçš„é¡åˆ¥èˆ‡å¯ç”¨å–®ä½ï¼ˆåŒä¸€é¡åˆ¥å…§éš¨æ©Ÿ from/toï¼‰</div>

        <div id="randomBlocks" style="margin-top:10px"></div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="startBtn">é–‹å§‹</button>
        <button class="btn secondary" id="resetBtn">é‡ç½®ç´€éŒ„</button>
        <span class="mini muted" id="saveHint">è¨­å®šæœƒè‡ªå‹•ä¿å­˜</span>
      </div>

      <div class="hint" id="factorHint"></div>
    </section>

    <!-- ä½œç­”å€ -->
    <section class="card" id="playCard">
      <h2>ä½œç­”</h2>

      <div class="row" style="justify-content:space-between">
        <div class="mini" id="progress">å°šæœªé–‹å§‹</div>
        <div class="mini" id="timerBox">â±ï¸ --</div>
      </div>

      <div class="question" id="question">â€”</div>
      <div class="sub" id="qSub">è«‹æŒ‰ã€Œé–‹å§‹ã€</div>

      <div class="row" style="margin-top:12px">
        <input id="answer" type="text" inputmode="numeric" placeholder="è¼¸å…¥ç­”æ¡ˆï¼ˆæ•´æ•¸ï¼‰"/>
        <button class="btn" id="submitBtn" disabled>é€å‡º</button>
        <button class="btn secondary" id="skipBtn" disabled>è·³é</button>
        <label class="chip" style="cursor:pointer">
          <input id="showHint" type="checkbox"/> é¡¯ç¤ºæ›ç®—æç¤º
        </label>
      </div>

      <div class="statline" style="margin-top:12px">
        <span class="badge">ç­”å°ï¼š<b id="ok">0</b></span>
        <span class="badge">ç­”éŒ¯ï¼š<b id="bad">0</b></span>
        <span class="badge">è¶…æ™‚ï¼š<b id="timeout">0</b></span>
        <span class="badge">æ­£ç¢ºç‡ï¼š<b id="acc">0.0%</b></span>
        <span class="badge">å¹³å‡åæ‡‰ï¼š<b id="avg">0.00s</b></span>
      </div>

      <table>
        <thead>
          <tr>
            <th class="right">#</th>
            <th>é¡Œç›®</th>
            <th>ä½ çš„ç­”æ¡ˆ</th>
            <th>æ­£ç¢ºç­”æ¡ˆ</th>
            <th>çµæœ</th>
            <th class="right">åæ‡‰(ç§’)</th>
            <th class="right">æ™‚é–“</th>
          </tr>
        </thead>
        <tbody id="log"></tbody>
      </table>
    </section>
  </div>

  <div class="mini muted" style="margin-top:12px">
    âœ… ç‰¹è‰²ï¼šå¦‚æœæ›ç®—æœƒç”¢ç”Ÿå°æ•¸ï¼Œé¡Œç›®æœƒæ”¹ç”¨ã€Œè¤‡åˆå–®ä½ã€è¡¨ç¤ºï¼ˆä¾‹å¦‚ 6 m 50 cmï¼‰ï¼Œè®“ç­”æ¡ˆä»ç„¶æ˜¯æ•´æ•¸ã€‚
  </div>
</div>

<script>
/** =========================
 *  å–®ä½è³‡æ–™ï¼ˆåŒä¸€é¡åˆ¥å…§æ›ç®—ï¼‰
 *  æˆ‘å€‘ç”¨ "base" åšæœ€å°å–®ä½æ•´æ•¸è¡¨ç¤ºï¼Œé¿å…å°æ•¸ã€‚
 *  é¡¯ç¤ºæ™‚è‹¥ç„¡æ³•æ•´é™¤ fromUnitï¼Œæœƒç”¨ã€ŒfromUnit + ä¸‹ä¸€éšå°å–®ä½ã€è¡¨ç¤ºï¼ˆè¤‡åˆå–®ä½ï¼‰ã€‚
 * ========================= */

const CATS = {
  length: {
    name: "é•·åº¦",
    units: [
      { key:"km", label:"km", factor: 1000*100*10 }, // base = mm
      { key:"m",  label:"m",  factor: 100*10 },
      { key:"cm", label:"cm", factor: 10 },
      { key:"mm", label:"mm", factor: 1 }
    ],
    baseLabel: "mm"
  },
  weight: {
    name: "é‡é‡",
    units: [
      { key:"kg", label:"kg", factor: 1000 }, // base = g
      { key:"g",  label:"g",  factor: 1 }
    ],
    baseLabel: "g"
  },
  volume: {
    name: "é«”ç©",
    units: [
      { key:"m3",  label:"mÂ³",  factor: 1000*1000*1000 }, // base = cm^3 (= mL)
      { key:"l",   label:"L",   factor: 1000 },
      { key:"ml",  label:"mL",  factor: 1 },              // = cm^3
      { key:"cm3", label:"cmÂ³", factor: 1 }
    ],
    baseLabel: "cmÂ³"
  },
  time: {
    name: "æ™‚é–“",
    units: [
      { key:"day", label:"day", factor: 24*60*60 }, // base = s
      { key:"hr",  label:"hr",  factor: 60*60 },
      { key:"min", label:"min", factor: 60 },
      { key:"s",   label:"s",   factor: 1 }
    ],
    baseLabel: "s"
  },
  area: {
    name: "é¢ç©",
    units: [
      { key:"m2",  label:"mÂ²",  factor: 10000 }, // base = cm^2
      { key:"cm2", label:"cmÂ²", factor: 1 }
    ],
    baseLabel: "cmÂ²"
  }
};

function $(id){ return document.getElementById(id); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function pad2(n){ return String(n).padStart(2,"0"); }
function nowTimeStr(){
  const d=new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function getUnit(catKey, unitKey){
  return CATS[catKey].units.find(u=>u.key===unitKey);
}
function unitIndex(catKey, unitKey){
  return CATS[catKey].units.findIndex(u=>u.key===unitKey);
}
function nextSmallerUnit(catKey, unitKey){
  const i = unitIndex(catKey, unitKey);
  if(i<0) return null;
  const units = CATS[catKey].units;
  return (i < units.length-1) ? units[i+1] : null;
}

/** ç”¢ç”Ÿä¸»æ•¸å­—ï¼ˆ1/2/3ä½æ•¸ï¼‰ */
function genMainByDigits(digits){
  digits = Number(digits);
  if(digits===1) return randInt(1,9);
  if(digits===2) return randInt(10,99);
  return randInt(100,999);
}

/**
 * ç”Ÿæˆä¸€é¡Œï¼š
 * - catKey: é¡åˆ¥
 * - fromKey/toKey: å–®ä½
 * - digits: ä¸»æ•¸å­—ä½æ•¸
 * ç›®æ¨™ï¼šç­”æ¡ˆä¸€å®šæ˜¯æ•´æ•¸ï¼Œé¡Œç›®é¿å…å°æ•¸ï¼ˆå¿…è¦æ™‚ç”¨è¤‡åˆå–®ä½ï¼‰
 */
function generateQuestion(catKey, fromKey, toKey, digits){
  const cat = CATS[catKey];
  const fromU = getUnit(catKey, fromKey);
  const toU   = getUnit(catKey, toKey);

  // 1) æ±ºå®šè¦ç”¨ã€Œä¸»æ•¸å­—ã€å¤šå°‘ï¼ˆ1/2/3ä½æ•¸ï¼‰
  const main = genMainByDigits(digits);

  // 2) æˆ‘å€‘å…ˆç”¨ base ä¾†çµ„è£é¡Œç›®æ•¸å€¼ï¼Œç¢ºä¿ç­”æ¡ˆç‚ºæ•´æ•¸
  //    baseValue = main * fromFactor + sub * nextFactor (å¦‚æœè¦ç”¨è¤‡åˆå–®ä½)
  //    ä¸¦ä¸”è¦æ±‚ baseValue % toFactor == 0ï¼Œæ‰èƒ½ä¿è­‰ç­”æ¡ˆç‚ºæ•´æ•¸
  const nextU = nextSmallerUnit(catKey, fromKey);

  // sub çš„ä¸Šé™ï¼šå¦‚æœ next å­˜åœ¨ï¼Œsub å¯åœ¨ [0, ratio-1] ä¹‹é–“
  // ratio = fromFactor / nextFactor
  let maxSub = 0;
  let ratio = 0;
  if(nextU){
    ratio = Math.floor(fromU.factor / nextU.factor);
    maxSub = Math.max(0, ratio - 1);
  }

  // 3) å˜—è©¦æ‰¾ä¸€å€‹ sub è®“ç­”æ¡ˆæ•´æ•¸ï¼ˆæ‰¾ä¸åˆ°å°± sub=0ï¼Œä¸”å¿…è¦æ™‚æ›ä¸€å€‹ mainï¼‰
  let sub = 0;
  let baseValue = main * fromU.factor;

  const tries = 300;
  let ok = false;

  for(let t=0;t<tries;t++){
    // æœ‰ next æ‰æœƒè€ƒæ…® sub
    let candidateSub = 0;
    if(nextU && maxSub>0){
      candidateSub = randInt(0, maxSub);
    }

    const candidateBase = main * fromU.factor + candidateSub * (nextU ? nextU.factor : 0);

    // ç­”æ¡ˆè¦æ•´æ•¸
    if(candidateBase % toU.factor === 0){
      sub = candidateSub;
      baseValue = candidateBase;
      ok = true;
      break;
    }

    // è‹¥ä¸€ç›´ä¸è¡Œï¼Œå¶çˆ¾æ› mainï¼ˆä»ç¶­æŒä½æ•¸ï¼‰
    if(t % 30 === 29){
      const newMain = genMainByDigits(digits);
      // ä¸è¦è®“ main è®Šæˆ 0 æˆ–ç ´å£ä½æ•¸ï¼ˆgenMainByDigits å·²ä¿è­‰ï¼‰
      // ä½†é¿å…åŒä¸€å€‹ main å¡æ­»ï¼šç›´æ¥è¦†è“‹
      //ï¼ˆæ³¨æ„ï¼šé€™è£¡åªæ”¹ main è®Šæ•¸çš„å€¼æœƒæ›´ä¹¾æ·¨ï¼Œä½† main æ˜¯ constï¼Œæ‰€ä»¥ç”¨å°æŠ€å·§ï¼‰
      // => æ”¹ç”¨æš«å­˜
    }
  }

  // ä¸Šé¢ const main ä¸èƒ½æ”¹ï¼Œæ‰€ä»¥å¦‚æœæ²’æˆåŠŸå°±ç”¨ä¿å®ˆç­–ç•¥ï¼šç›´æ¥æ‰¾ baseValue è®“ from é¡¯ç¤ºåˆç†
  if(!ok){
    // é€€è€Œæ±‚å…¶æ¬¡ï¼šå›ºå®š sub=0ï¼Œæ‰¾ä¸€å€‹ baseValue åŒæ™‚è®“ç­”æ¡ˆæ•´æ•¸
    // baseValue = main * fromFactor * kï¼ŒæŒ‘ k è®“å¯æ•´é™¤ toFactorï¼Œä¸”åˆ¥å¤ªå¤§
    let kFound = 1;
    for(let k=1;k<=50;k++){
      const candidateBase = main * fromU.factor * k;
      if(candidateBase % toU.factor === 0){
        kFound = k; baseValue = candidateBase; break;
      }
    }
  }

  const ans = baseValue / toU.factor;

  // 4) æ±ºå®šé¡Œç›®é¡¯ç¤ºå­—ä¸²ï¼šè‹¥ sub>0 ç”¨è¤‡åˆå–®ä½ï¼ˆfrom + nextï¼‰
  let displayValue = "";
  if(nextU && (baseValue % fromU.factor !== 0)){
    // ç”¨ baseValue æ‹†æˆ mainPart + subPart
    const mainPart = Math.floor(baseValue / fromU.factor);
    const rem = baseValue % fromU.factor;
    const subPart = Math.floor(rem / nextU.factor);
    // é¡Œç›®åƒï¼š6 m 50 cm
    displayValue = `${mainPart} ${fromU.label} ${subPart} ${nextU.label}`;
  }else{
    // å–®ä¸€å–®ä½
    const v = Math.floor(baseValue / fromU.factor);
    displayValue = `${v} ${fromU.label}`;
  }

  const qText = `${displayValue} = ? ${toU.label}`;

  // 5) æç¤ºï¼ˆé¡¯ç¤ºç›¸é„°æ›ç®—ï¼‰
  const hint = buildHint(catKey);

  return {
    catKey, fromKey, toKey,
    qText,
    ans,
    hint,
    baseValue
  };
}

function buildHint(catKey){
  const units = CATS[catKey].units;
  // é¡¯ç¤ºç›¸é„°æç¤ºï¼š1 A = k B
  let lines = [];
  for(let i=0;i<units.length-1;i++){
    const big = units[i];
    const small = units[i+1];
    const k = big.factor / small.factor;
    // åªé¡¯ç¤ºæ•´æ•¸æ›ç®—ï¼ˆæˆ‘å€‘çš„è¨­è¨ˆéƒ½æœƒæ˜¯æ•´æ•¸ï¼‰
    lines.push(`ğŸ‘‰ 1 ${big.label} = ${k} ${small.label}`);
  }
  return lines.join("\n");
}

/** =========================
 *  UI & ç‹€æ…‹
 * ========================= */
let mode = "directed";
let running = false;

let total = 20;
let timePerQ = 20;
let noTimer = false;
let digits = 3;

let qIndex = 0;
let current = null;
let tStart = 0;
let timer = null;
let remain = 0;

let stats = { ok:0, bad:0, timeout:0, sumRT:0, done:0 };

function setMode(m){
  mode = m;
  document.querySelectorAll(".tab").forEach(el=>{
    el.classList.toggle("active", el.dataset.mode===m);
  });
  $("directedPanel").style.display = (m==="directed") ? "block" : "none";
  $("randomPanel").style.display   = (m==="random") ? "block" : "none";
  saveSettings();
}

function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem("uc_settings")||"{}");
    if(s.totalQ) $("totalQ").value = s.totalQ;
    if(s.timePerQ) $("timePerQ").value = s.timePerQ;
    if(typeof s.noTimer==="boolean") $("noTimer").checked = s.noTimer;
    if(s.digits) $("digits").value = s.digits;
    if(s.mode) setMode(s.mode);

    if(s.directedCat) $("catDirected").value = s.directedCat;

    // random selections
    if(s.random){
      for(const catKey in CATS){
        const blk = document.querySelector(`[data-rand-cat="${catKey}"]`);
        if(!blk) continue;
        const catOn = blk.querySelector(`input[data-role="catOn"]`);
        if(catOn && typeof s.random[catKey]?.enabled==="boolean"){
          catOn.checked = s.random[catKey].enabled;
        }
        const allowed = s.random[catKey]?.allowed || {};
        blk.querySelectorAll(`input[data-role="unit"]`).forEach(cb=>{
          const key = cb.value;
          if(typeof allowed[key]==="boolean") cb.checked = allowed[key];
        });
      }
    }
  }catch(e){}
}

function saveSettings(){
  const s = {
    mode,
    totalQ: Number($("totalQ").value),
    timePerQ: Number($("timePerQ").value),
    noTimer: $("noTimer").checked,
    digits: Number($("digits").value),
    directedCat: $("catDirected").value,
    directedFrom: $("fromUnit").value,
    directedTo: $("toUnit").value,
    random: collectRandomConfig()
  };
  localStorage.setItem("uc_settings", JSON.stringify(s));
}

function resetLog(){
  $("log").innerHTML = "";
  stats = { ok:0, bad:0, timeout:0, sumRT:0, done:0 };
  updateStats();
  $("progress").textContent = "å°šæœªé–‹å§‹";
  $("timerBox").textContent = "â±ï¸ --";
  $("question").textContent = "â€”";
  $("qSub").textContent = "è«‹æŒ‰ã€Œé–‹å§‹ã€";
  $("answer").value = "";
}

function updateStats(){
  $("ok").textContent = stats.ok;
  $("bad").textContent = stats.bad;
  $("timeout").textContent = stats.timeout;

  const acc = stats.done ? (stats.ok / stats.done * 100) : 0;
  $("acc").textContent = acc.toFixed(1) + "%";

  const avg = stats.done ? (stats.sumRT / stats.done) : 0;
  $("avg").textContent = avg.toFixed(2) + "s";
}

function stopTimer(){
  if(timer){ clearInterval(timer); timer=null; }
}
function startTimer(){
  stopTimer();
  if(noTimer){
    $("timerBox").textContent = "â±ï¸ ä¸é™æ™‚";
    return;
  }
  remain = timePerQ;
  $("timerBox").textContent = `â±ï¸ ${remain}s`;
  timer = setInterval(()=>{
    remain--;
    $("timerBox").textContent = `â±ï¸ ${remain}s`;
    if(remain<=0){
      stopTimer();
      markTimeout();
    }
  }, 1000);
}

function collectRandomConfig(){
  const cfg = {};
  for(const catKey in CATS){
    const blk = document.querySelector(`[data-rand-cat="${catKey}"]`);
    if(!blk) continue;
    const enabled = blk.querySelector(`input[data-role="catOn"]`)?.checked || false;
    const allowed = {};
    blk.querySelectorAll(`input[data-role="unit"]`).forEach(cb=>{
      allowed[cb.value] = cb.checked;
    });
    cfg[catKey] = { enabled, allowed };
  }
  return cfg;
}

function getRandomPlan(){
  const cfg = collectRandomConfig();
  const enabledCats = Object.keys(cfg).filter(k=>cfg[k].enabled);

  // è‹¥ä½¿ç”¨è€…éƒ½æ²’å‹¾ï¼Œä¿å®ˆï¼šå…¨é–‹
  const cats = enabledCats.length ? enabledCats : Object.keys(CATS);

  // æŒ‘ä¸€å€‹é¡åˆ¥
  const catKey = cats[randInt(0, cats.length-1)];
  const units = CATS[catKey].units.map(u=>u.key);

  // ä¾å…è¨±å–®ä½éæ¿¾
  const allowedMap = cfg[catKey]?.allowed || {};
  const allowedUnits = units.filter(u=> allowedMap[u] !== false); // æ²’å­˜éå°±è¦–ç‚º true

  // è‹¥å…¨è¢«é—œæ‰ï¼Œå›åˆ°è©²é¡åˆ¥æ‰€æœ‰
  const pool = allowedUnits.length ? allowedUnits : units;

  // éš¨æ©Ÿ from/toï¼ˆä¸åŒï¼‰
  let from = pool[randInt(0,pool.length-1)];
  let to = pool[randInt(0,pool.length-1)];
  if(pool.length>1){
    while(to===from) to = pool[randInt(0,pool.length-1)];
  }
  return { catKey, from, to };
}

function buildDirectedSelectors(){
  // é¡åˆ¥é¸å–®
  $("catDirected").innerHTML = Object.keys(CATS).map(k=>{
    return `<option value="${k}">${CATS[k].name}</option>`;
  }).join("");

  function refreshUnits(){
    const catKey = $("catDirected").value;
    const units = CATS[catKey].units;

    const opt = units.map(u=>`<option value="${u.key}">${u.label}</option>`).join("");
    $("fromUnit").innerHTML = opt;
    $("toUnit").innerHTML = opt;

    // è‹¥ä¹‹å‰æœ‰ä¿å­˜ï¼Œå˜—è©¦æ¢å¾©ï¼›å¦å‰‡çµ¦é è¨­ä¸åŒå–®ä½
    const s = JSON.parse(localStorage.getItem("uc_settings")||"{}");
    if(s.directedFrom && getUnit(catKey, s.directedFrom)) $("fromUnit").value = s.directedFrom;
    if(s.directedTo && getUnit(catKey, s.directedTo)) $("toUnit").value = s.directedTo;

    if($("toUnit").value === $("fromUnit").value && units.length>1){
      $("toUnit").value = units[units.length-1].key;
      if($("toUnit").value === $("fromUnit").value) $("toUnit").value = units[0].key;
    }

    // æç¤º
    $("factorHint").textContent = buildHint(catKey);
    $("factorHint").classList.toggle("show", $("showHint").checked);
  }

  $("catDirected").addEventListener("change", ()=>{
    refreshUnits();
    saveSettings();
  });
  $("fromUnit").addEventListener("change", saveSettings);
  $("toUnit").addEventListener("change", saveSettings);

  refreshUnits();
}

function buildRandomBlocks(){
  const host = $("randomBlocks");
  host.innerHTML = "";

  for(const catKey in CATS){
    const cat = CATS[catKey];
    const blk = document.createElement("div");
    blk.className = "card";
    blk.style.background = "rgba(15,27,51,0.55)";
    blk.style.marginTop = "10px";
    blk.setAttribute("data-rand-cat", catKey);

    const unitChips = cat.units.map(u=>{
      return `
        <label class="chip" style="cursor:pointer">
          <input data-role="unit" type="checkbox" value="${u.key}" checked />
          ${u.label}
        </label>`;
    }).join("");

    blk.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b style="color:#dfeaff">${cat.name}</b> <span class="mini muted">ï¼ˆåŒé¡åˆ¥å…§éš¨æ©Ÿï¼‰</span></div>
        <label class="chip" style="cursor:pointer">
          <input data-role="catOn" type="checkbox" checked /> å•Ÿç”¨æ­¤é¡åˆ¥
        </label>
      </div>
      <div class="checks">${unitChips}</div>
      <div class="mini muted" style="margin-top:6px">${buildHint(catKey).replaceAll("\n"," / ")}</div>
    `;

    host.appendChild(blk);

    blk.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("change", saveSettings);
    });
  }
}

function setHintVisible(){
  const catKey = (mode==="directed") ? $("catDirected").value : (current?.catKey || "length");
  $("factorHint").textContent = buildHint(catKey);
  $("factorHint").classList.toggle("show", $("showHint").checked);
}

function nextQuestion(){
  qIndex++;
  $("progress").textContent = `ç¬¬ ${qIndex} / ${total} é¡Œ`;

  // ç”¢ç”Ÿé¡Œç›®
  let plan;
  if(mode==="directed"){
    const catKey = $("catDirected").value;
    const from = $("fromUnit").value;
    const to = $("toUnit").value;
    plan = { catKey, from, to };
  }else{
    plan = getRandomPlan();
  }

  // è‹¥ from/to ç›¸åŒï¼Œå¼·åˆ¶æ›ä¸€å€‹ to
  if(plan.from === plan.to){
    const units = CATS[plan.catKey].units.map(u=>u.key).filter(u=>u!==plan.from);
    if(units.length) plan.to = units[randInt(0, units.length-1)];
  }

  current = generateQuestion(plan.catKey, plan.from, plan.to, digits);

  $("question").textContent = current.qText;
  $("qSub").textContent = `é¡åˆ¥ï¼š${CATS[current.catKey].name}ï½œç­”æ¡ˆç‚ºæ•´æ•¸ï¼ˆå¿…è¦æ™‚ç”¨è¤‡åˆå–®ä½å‡ºé¡Œï¼‰`;
  $("answer").value = "";
  $("answer").focus();

  tStart = performance.now();
  startTimer();
  setHintVisible();
}

function finish(){
  running = false;
  stopTimer();
  $("submitBtn").disabled = true;
  $("skipBtn").disabled = true;
  $("startBtn").disabled = false;
  $("progress").textContent = `å®Œæˆï¼å…± ${total} é¡Œï½œæ­£ç¢ºç‡ ${$("acc").textContent}`;
  $("timerBox").textContent = "â±ï¸ --";
}

function addLogRow({idx, qText, your, correct, result, rt, timeStr}){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="right">${idx}</td>
    <td>${escapeHtml(qText)}</td>
    <td>${escapeHtml(String(your))}</td>
    <td>${escapeHtml(String(correct))}</td>
    <td>${resultBadge(result)}</td>
    <td class="right">${rt.toFixed(2)}</td>
    <td class="right">${escapeHtml(timeStr)}</td>
  `;
  $("log").prepend(tr);
}
function resultBadge(r){
  if(r==="ç­”å°") return `<span class="badge ok">ç­”å°</span>`;
  if(r==="è¶…æ™‚") return `<span class="badge warn">è¶…æ™‚</span>`;
  return `<span class="badge bad">ç­”éŒ¯</span>`;
}
function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function markTimeout(){
  if(!running) return;
  const rt = (performance.now()-tStart)/1000;

  stats.timeout++;
  stats.done++;
  stats.sumRT += rt;
  updateStats();

  addLogRow({
    idx:qIndex,
    qText: current.qText,
    your: "â€”",
    correct: current.ans,
    result: "è¶…æ™‚",
    rt,
    timeStr: nowTimeStr()
  });

  if(qIndex>=total) finish();
  else nextQuestion();
}

function submit(){
  if(!running) return;
  stopTimer();
  const rt = (performance.now()-tStart)/1000;

  const raw = $("answer").value.trim();
  // åªæ¥å—æ•´æ•¸ï¼ˆå¯å«æ­£è² è™Ÿï¼Œä½†é€šå¸¸ä¸æœƒï¼‰
  const your = (/^-?\d+$/.test(raw)) ? Number(raw) : NaN;

  let result = "ç­”éŒ¯";
  if(Number.isFinite(your) && your === current.ans){
    result = "ç­”å°";
    stats.ok++;
  }else{
    stats.bad++;
  }

  stats.done++;
  stats.sumRT += rt;
  updateStats();

  addLogRow({
    idx:qIndex,
    qText: current.qText,
    your: raw==="" ? "ï¼ˆç©ºç™½ï¼‰" : raw,
    correct: current.ans,
    result,
    rt,
    timeStr: nowTimeStr()
  });

  if(qIndex>=total) finish();
  else nextQuestion();
}

function skip(){
  if(!running) return;
  stopTimer();
  const rt = (performance.now()-tStart)/1000;

  stats.bad++;
  stats.done++;
  stats.sumRT += rt;
  updateStats();

  addLogRow({
    idx:qIndex,
    qText: current.qText,
    your: "ï¼ˆè·³éï¼‰",
    correct: current.ans,
    result: "ç­”éŒ¯",
    rt,
    timeStr: nowTimeStr()
  });

  if(qIndex>=total) finish();
  else nextQuestion();
}

function start(){
  // è®€è¨­å®š
  total = clamp(Number($("totalQ").value)||20, 1, 200);
  timePerQ = clamp(Number($("timePerQ").value)||20, 1, 999);
  noTimer = $("noTimer").checked;
  digits = clamp(Number($("digits").value)||3, 1, 3);

  // å®šå‘æ¨¡å¼ï¼šé¿å… from/to ç›¸åŒ
  if(mode==="directed" && $("fromUnit").value === $("toUnit").value){
    const catKey = $("catDirected").value;
    const units = CATS[catKey].units.map(u=>u.key).filter(u=>u!==$("fromUnit").value);
    if(units.length) $("toUnit").value = units[0];
  }

  saveSettings();

  // é‡ç½®ç‹€æ…‹
  running = true;
  qIndex = 0;
  stats = { ok:0, bad:0, timeout:0, sumRT:0, done:0 };
  updateStats();
  $("log").innerHTML = "";

  $("startBtn").disabled = true;
  $("submitBtn").disabled = false;
  $("skipBtn").disabled = false;

  nextQuestion();
}

function wireEvents(){
  // tabs
  document.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=> setMode(el.dataset.mode));
  });

  ["totalQ","timePerQ","noTimer","digits"].forEach(id=>{
    $(id).addEventListener("change", saveSettings);
  });

  $("showHint").addEventListener("change", setHintVisible);

  $("startBtn").addEventListener("click", start);
  $("resetBtn").addEventListener("click", ()=>{
    localStorage.removeItem("uc_settings");
    resetLog();
    // é‡æ–°å»ºç«‹ UI
    buildDirectedSelectors();
    buildRandomBlocks();
    loadSettings();
    setHintVisible();
  });

  $("submitBtn").addEventListener("click", submit);
  $("skipBtn").addEventListener("click", skip);
  $("answer").addEventListener("keydown", (e)=>{
    if(e.key==="Enter") submit();
  });
}

function init(){
  buildDirectedSelectors();
  buildRandomBlocks();
  loadSettings();
  setHintVisible();
  resetLog();

  // PWA: service worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
}
wireEvents();
init();
</script>
</body>
</html>
